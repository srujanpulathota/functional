[CmdLetBinding()]
Param (
    [Parameter (Mandatory = $true)]
    [String] $SubscriptionName,
    [Parameter (Mandatory = $true)]
    [String] $ParameterFilePath,
    [Parameter(Mandatory = $false)]
    [String] $EndpointsFilePath
)


# Install and import Az module
Install-Module -Name Az -Scope CurrentUser -Force -AllowClobber
Import-Module -Name Az -Force
Install-Module -name az -Scope CurrentUser -Force
Import-Module -name az -Global -Force


# Login using SPN credentials
if ($SubscriptionName -eq 'Azure.IOTNPE') {
    $spnKey = $env:AZ_SERVICE_PRINCIPAL_PASSWORD
    $spnId = $env:AZ_SERVICE_PRINCIPAL_ID
}
elseif ($SubscriptionName -eq 'Azure.IOTPROD') {
    $spnKey = $env:AZ_SERVICE_PRINCIPAL_PASSWORD_PROD
    $spnId = $env:AZ_SERVICE_PRINCIPAL_ID_PROD
}

$tenantId = $env:AZ_SERVICE_PRINCIPAL_TENANT
$SecuredPassword = ConvertTo-SecureString -String $spnKey -AsPlainText -Force
$Credential = New-Object System.Management.Automation.PSCredential($spnId, $SecuredPassword)


Connect-AzAccount -ServicePrincipal -TenantId $tenantId -Credential $Credential
Select-AzSubscription -SubscriptionName $SubscriptionName

# Load parameter file
$appServices = Get-Content -Path $ParameterFilePath | ConvertFrom-Json
$reportPath = "connectivity_report.csv"
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Load endpoints
if ($EndpointsFilePath) {
    $endpoints = (Import-Csv -Path $EndpointsFilePath).Endpoint
} else {
    Write-Host "❌ No endpoints file provided" -ForegroundColor Red
    exit 1
}

Write-Host "✅ Testing $($endpoints.Count) endpoints across $($appServices.appServices.Count) App Services."

# Create Runspace Pool
$runspacePool = [runspacefactory]::CreateRunspacePool(1, 15) # 15 threads max
$runspacePool.Open()
$jobs = @()

foreach ($appService in $appServices.appServices) {
    $appName       = $appService.name
    $resourceGroup = $appService.resourceGroup

    # Get Kudu credentials for this App Service
    $publishingProfile = Get-AzWebAppPublishingProfile -Name $appName -ResourceGroupName $resourceGroup -OutputFile null
    $xml      = [xml]$publishingProfile
    $userName = $xml.publishData.publishProfile[0].userName
    $password = $xml.publishData.publishProfile[0].userPWD
    $pair         = "${userName}:${password}"
    $encodedCreds = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes($pair))
    $headers      = @{ Authorization = "Basic $encodedCreds"; Accept = "application/json" }
    $kuduUrl      = "https://$appName.scm.azurewebsites.net/api/command?waitForExit=true&log=true"

    foreach ($endpoint in $endpoints) {
        $ps = [powershell]::Create()
        $ps.RunspacePool = $runspacePool

        $null = $ps.AddScript({
            param($endpoint, $headers, $kuduUrl, $appName, $resourceGroup)
            $status = "Fail"; $httpCode = "000"; $protocol = ""; $ErrorMessage = ""; $connectionInfo = ""; $attempt = 0; $maxAttempts = 3

            while ($attempt -lt $maxAttempts) {
                try {
                    $attempt++
                    # Curl verbose output
                    $command = "curl -skv $endpoint 2>&1"
                    $body    = @{ command = $command; dir = "/home" } | ConvertTo-Json
                    $response = Invoke-RestMethod -Uri $kuduUrl -Method POST -Body $body -ContentType "application/json" -Headers $headers
                    # ✅ Normalize output
                    $rawOutput = $response.Output -replace "`r","" -split "`n"

            # Extract HTTP code and protocol from verbose output
            $httpMatches = ($rawOutput | Select-String 'HTTP/[0-9.]+\s+([0-9]{3})')
            if ($httpMatches) {
                $lastMatch = $httpMatches[-1]
                $httpCode = $lastMatch.Matches.Groups[1].Value
                $protocol = ($lastMatch.Matches.Groups[0].Value -split ' ')[0] -replace 'HTTP/', ''
            } else {
                # Fallback: check JSON error for status
                $jsonStatus = ($rawOutput | Select-String '"status"\s*:\s*"([0-9]{3})"')
                if ($jsonStatus) {
                    $httpCode = $jsonStatus.Matches.Groups[1].Value
                }
            }

            # Capture connection info
            $connectionInfo = ($rawOutput | Where-Object { $_ -match '^Connected to' }) -join '; '


                # Determine status
                $allowedCodes = @("200","201","204","400","401","403","404")
                if ($httpCode -in $allowedCodes) {
                $status = "Pass"
            } elseif ($connectionInfo) {
                $status = "Pass"
            } elseif ($rawOutput -match 'Could not resolve host') {
                $status = "Fail"
            } else {
                $status = "Fail"
            }
            if ($status -eq "Fail") {
                $ErrorMessage = ($rawOutput -join "`n")
            }
                    break
                } catch {
                    $ErrorMessage = $_.Exception.Message
                }
                Start-Sleep -Seconds 5
            }

            [PSCustomObject]@{
                AppService    = $appName
                ResourceGroup = $resourceGroup
                Endpoint      = $endpoint
                HTTPCode      = $httpCode
                Protocol      = $protocol
                Connection    = $connectionInfo
                Status        = $status
                ErrorMessage  = $ErrorMessage
                Timestamp     = (Get-Date).ToString("s")
            }
        }).AddArgument($endpoint).AddArgument($headers).AddArgument($kuduUrl).AddArgument($appName).AddArgument($resourceGroup)

        $jobs += [PSCustomObject]@{ Pipe = $ps; Handle = $ps.BeginInvoke() }
    }
}

# Collect results
$results = @()
$counter = 0
foreach ($job in $jobs) {
    $output = $job.Pipe.EndInvoke($job.Handle)
    $results += $output
    $job.Pipe.Dispose()
    $counter++
    if ($counter % 50 -eq 0) { Write-Host "Progress: $counter / $($jobs.Count) tests completed." }
}

# Close runspace pool
$runspacePool.Close()
$runspacePool.Dispose()

# Export results
$results | Export-Csv -Path $reportPath -NoTypeInformation
Write-Host "`n✅ Connectivity report generated at $reportPath"
